<div id="fb-root"></div>
<script src="http://connect.facebook.net/en_US/all.js"></script>
<style>
  .class {
    background-color: #C0D1D3;
    padding: 10px;
    margin: 10px;
    border-radius: 10px;
    display: inline-block;
  }
  
  .user {
    background-color: #77C484;
    padding: 10px;
    border-radius: 5px;
    display: inline-block;
    border: 1px solid #3AAA5A;
    margin: 5px;
  }
  
  body {
    font-family: sans-serif;
  }
  
</style>
<button id="button" onclick="login()">Show me who's in my classes!</button> <progress id="progress" value=0></progress> <span id="status"></span>
<br>
<script type="text/coffeescript">
  @me = {};
  @names = {}
  @times = {}
  
  selectors = [
    'strpos(lower(message), "3") >= 0'
  ]

  $ = (id) -> document.getElementById(id)
  
  t = new Date
  t.setTime(new Date - 1000 * 60 * 60 * 24 * 7 * 4) #4 weeks in the past
  time = Math.floor(t.getTime()/1000)
  
  filter = (list, func) -> x for x in list when func(x)
  
  FB.init {
    appId  : '282025336884',
    status : true, # check login status
    cookie : true, # enable cookies to allow the server to access the session
    xfbml  : true, # parse XFBML
    channelUrl : 'http://antimatter15.com/misc/schedule/channel.html', # channel.html file
    oauth  : true # enable OAuth 2.0
  }
  
  @login = ->
    $('button').disabled = true
    FB.login((resp) ->
      FB.api '/me', (resp) ->
        me = resp
        console.log(resp)
        names[me.id] = me.name
        getSchedule(me.id)
        getFriends()
    , {scope: 'read_stream'})
    
  
  
  getSchedule = (uid) ->
    FB.api {
      method: 'fql.query',
      query: "select message, uid from status where uid=#{uid} and time > #{time} and (#{selectors.join(' or ')})"
    }, (resp) ->
      handleMessage(uid, status.message) for status in resp
  
  handleMessage = (uid, msg) ->
    lines = for line in msg.split /\n|;/
      [(' ' + line + ' ').toLowerCase()
          .replace(/[^a-z0-9\s]/gi, ' ')
          .replace(/[a-z](\d+)/i, '$1')
          .replace(/(\d+)(st|nd|th|rd)/i, ' $1 ')
          .replace(/\s+/g, ' ')
          .replace(/^\s+|\s+$/g, '')
          .replace(/\s(i+)\s/g, (a,b) -> " #{b.length} ")
          .replace(/\s\d+(\s|$)/g, ' ')
          .replace(/([a-z])\d/g, ' $1 ')
          .replace(/\s[a-z]\s/g, ' ')
          .replace(/(\d+)([a-z])/i, '$1 $2')
          .replace(/^\s+|\s+$/g, ''), line]
    items = filter lines, (line) ->
      parts = line[0].split ' '
      len = parts.length
      len < 8 and !/sched/.test(parts[0])
    if 5 < items.length < 11
      nums = items.join(' ').match(/\d+/g)
      if !nums or nums.length < 3
        items = ("#{c+1} #{i[0]}" for i,c in items)
      for item in items
        name = item[1]
        tags = item[0]
        if num = tags.match(/\d+/)
          tags = tags
            .replace(/\s?\d+\s?/, ' ')
            .replace(/^\s+|\s+$/g, '')
          tags = num[0] + ' ' + tags
          classify(item[1], tags.split(' '), uid)
  
  @count = (p, tag) ->
    period = times[p]
    ents = period[tag].entities
    all = {}
    score = 0
    total = 0
    for v in ents
      for e in entities[v]
        all[e] = 1
    for v of all
      total++
    ents.length / total
    
  
  classify = (name, parts, uid) ->
    period = parts[0]
    parts = parts.slice(1)
    teacher = parts.slice(-1)[0]
    times[period] = {} unless times[period]?
    slot = times[period]
    slot[teacher] = {tag:[],names:[],people:[]} unless slot[teacher]?
    cls = slot[teacher]
    for tag in parts
      cls.tag.push(tag) unless tag in cls.tag
    cls.people.push(uid) unless uid in cls.people
    cls.names.push(name) unless name in cls.names
  
  
  
  classify2 = (name, parts, uid) ->
    
    best = [-1, -1000]
    period = parts[0]
    parts = parts.slice(1)
    times[period] = [] if !times[period]
    classes = times[period]
    console.log "classifying",name,parts,names[uid]
    return
    for cls, index in classes
      tags = cls.tag
      score = 0
      console.log(cls)
      #for part, index in parts
      #  mul = 1
      #  #mul = 3 if /\d+/.test(part) or index == parts.length - 1
      #  if part in tags
      #    score += 2 * mul
      #  else
      #    score += -1 * mul
      #if score > best[1]
      #  best = [index, score]
 
    if best[1] < 10
      classes.push {
        tag: parts.slice(0),
        names: [name],
        people: [uid]
      }
      cls = classes[best[0]]
      console.log("creating",names[uid],"as", cls.names[0], "only", best[1]) if cls
    else
      console.log("adding", names[uid], "to", cls.names[0], "because", best[1], cls.tag.slice(0), "is", parts.slice(0))
      #for tag in parts
      #  cls.tag.push(tag) unless tag in cls.tag
      #  
      #cls.people.push(uid) unless uid in cls.people
      #cls.names.push(name) unless name in cls.names

  
  
  getFriends = () ->
    FB.api '/me/friends', (resp) ->
      names[friend.id] = friend.name for friend in resp.data
      for id, name of names
        getSchedule(id)
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
</script>
<script src="coffee-script.js"></script>
